import inspect

import src.features.paper_1
from src.features.paper_1.vulnerability.ada.features_vulnerability_ada_processing import (
    AbstractFeatures_Vulnerability_ADA_Processing)

from src.base.files_manager.files_manager_abc import AbstractBaseFilesManager
from src.base.files_manager.files_export import DfExport
from src.base.files_manager.files_path import FilesManagerClassPaths, MethodPathOutput


class Features_Vulnerability_ADA_FilesManager(AbstractBaseFilesManager):
    def __init__(self, daymet_scaled_parquet_file: str, census_scaled_parquet_file: str,
                 outcomes_scaled_parquet_file: str, canue_scaled_parquet_file: str, ndvi_scaled_parquet_file: str,
                 features_vulnerability_processing_class: AbstractFeatures_Vulnerability_ADA_Processing):
        self.daymet_scaled_parquet_file = daymet_scaled_parquet_file
        self.census_scaled_parquet_file = census_scaled_parquet_file
        self.outcomes_scaled_parquet_file = outcomes_scaled_parquet_file
        self.canue_scaled_parquet_file = canue_scaled_parquet_file
        self.ndvi_scaled_parquet_file = ndvi_scaled_parquet_file
        self.feature_processing_class = features_vulnerability_processing_class

    @property
    def _files_manager_class_paths(self) -> FilesManagerClassPaths:
        return FilesManagerClassPaths(
            module_name=src.features.paper_1.__name__.split('.')[-2],
            optional_module_sub_dir=src.features.paper_1.__name__.split('.')[-1],
            files_manager_class_name=self.__class__.__name__,
            optional_filemanager_sub_dir=self.feature_processing_class.filename,
            processed_class_filename=self.feature_processing_class.filename)

    def select_daymet_variables(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        df_out = self.feature_processing_class.select_daymet_variables(
            daymet_parquet_file=self.daymet_scaled_parquet_file)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def select_census_age_variables(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        df_out = self.feature_processing_class.select_census_age_variables(
            census_parquet_file=self.census_scaled_parquet_file,
            census_year_start=self.feature_processing_class.census_year_start,
            census_year_end=2021)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def select_census_socioeco_variables(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        df_out = self.feature_processing_class.select_census_socioeco_variables(
            census_parquet_file=self.census_scaled_parquet_file,
            census_year_start=self.feature_processing_class.census_year_start,
            census_year_end=2021)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def select_outcomes_variable(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        df_out = self.feature_processing_class.select_outcomes_variables(
            outcomes_parquet_file=self.outcomes_scaled_parquet_file)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def select_canue_variable(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        df_out = self.feature_processing_class.select_canue_variables(
            canue_parquet_file=self.canue_scaled_parquet_file)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def select_ndvi_variable(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        df_out = self.feature_processing_class.select_ndvi_variables(ndvi_parquet_file=self.ndvi_scaled_parquet_file)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def concat_daymet_outcome(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        daymet_parquet_file = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.select_daymet_variables.__name__)

        outcome_parquet_file = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.select_outcomes_variable.__name__)

        df_out = self.feature_processing_class.concat_daymet_outcome(daymet_parquet_file=daymet_parquet_file,
                                                                     outcome_parquet_file=outcome_parquet_file)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def concat_census(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        census_age_parquet_file = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.select_census_age_variables.__name__)

        census_socioeco_parquet_file = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.select_census_socioeco_variables.__name__)

        df_out = self.feature_processing_class.concat_census(census_age_parquet_file=census_age_parquet_file,
                                                             census_socioeco_parquet_file=census_socioeco_parquet_file)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def concat_variables(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        census_parquet_file = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.concat_census.__name__)

        daymet_outcome_parquet_file = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.concat_daymet_outcome.__name__)

        ndvi_parquet_file = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.select_ndvi_variable.__name__)

        canue_parquet_file = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.select_canue_variable.__name__)

        df_out = self.feature_processing_class.concat_variables(census_parquet_file=census_parquet_file,
                                                                daymet_outcome_parquet_file=daymet_outcome_parquet_file,
                                                                ndvi_parquet_file=ndvi_parquet_file,
                                                                canue_parquet_file=canue_parquet_file)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def standardize_format(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        path_in = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.concat_variables.__name__)

        df_out = self.feature_processing_class.standardize_format(
            concat_variables_parquet_file=path_in)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def features_census_stats(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        path_in = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.standardize_format.__name__)

        df_out = self.feature_processing_class.features_census_stats(standardize_format_parquet_file=path_in)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def features_study_stats(self):
        method_path = MethodPathOutput(files_manager_class_paths=self.files_manager_class_paths,
                                       current_method_name=inspect.currentframe().f_code.co_name)

        path_in = self.files_manager_class_paths.load_previous_method_file(
            previous_method_name=self.standardize_format.__name__)

        df_out = self.feature_processing_class.features_study_stats(standardize_format_parquet_file=path_in)

        export_result = DfExport(df_out=df_out,
                                 path_out=method_path.path_out,
                                 filename_out=method_path.filename_out)
        export_result.to_parquet()
        export_result.to_csv()
        export_result.metadata_to_json()

    def make_files(self, select_daymet_variables: bool = False, select_census_age_variables: bool = False,
                   select_census_socioeco_variables: bool = False, select_outcomes_variable: bool = False,
                   select_canue_variable: bool = False, select_ndvi_variable: bool = False,
                   concat_daymet_outcome: bool = False, concat_census: bool = False, concat_variables: bool = False,
                   standardize_format: bool = False, features_census_stats: bool = False,
                   features_study_stats: bool = False, make_all: bool = False):
        if select_daymet_variables | make_all:
            self.select_daymet_variables()
        if select_census_age_variables | make_all:
            self.select_census_age_variables()
        if select_census_socioeco_variables | make_all:
            self.select_census_socioeco_variables()
        if select_outcomes_variable | make_all:
            self.select_outcomes_variable()
        if select_canue_variable | make_all:
            self.select_canue_variable()
        if select_ndvi_variable | make_all:
            self.select_ndvi_variable()
        if concat_daymet_outcome | make_all:
            self.concat_daymet_outcome()
        if concat_census | make_all:
            self.concat_census()
        if concat_variables | make_all:
            self.concat_variables()
        if standardize_format | make_all:
            self.standardize_format()
        if features_census_stats | make_all:
            self.features_census_stats()
        if features_study_stats | make_all:
            self.features_study_stats()
